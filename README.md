# Файловая база знаний на FastAPI с полнотекстовым поиском
Этот проект позволяет создать индекс с помощью библиотеки Whoosh по всем текстовым файлам в указанной локальной директории. 
Поддерживаются все текстовые форматы файлов txt, py, yaml и др., в т.ч. docx, pptx, xlsx, pdf. 
Для конвертации файлов в единый текстовый формат markdown используется новая библиотека markitdown.
Созданный индекс далее используется для полнотекстового поиска по всем документам в базе через веб-интерфейс (FastAPI + Jinja2).

## Основные возможности
1. **Клонирование git-репозиториев (опционально, можно использовать свои локальные файлы):**
   - Создание списка проектов по всем группам внутри указанной группы GitLab
   - Обновление ранее склонированных проектов

2. **Создание индекса для поиска:**
   - Подготовка списка файлов для добавления в индекс в указанной директории
   - Фильтрация файлов по расширениям
   - Добавление в индекс файлов, которые менялись после даты последней индексации

3. **Поиск по всем проиндексированным файлам в web-приложении:**
   - Поиск файлов, содержащих заданную фразу
   - Просмотр файлов в браузере

## Технологический стек
- **Веб-фреймворк:** FastAPI
- **Индексация файлов для поиска:** Whoosh
- **Конвертация в MD:** markitdown
- **Фронтенд:** HTML + CSS + JS (с использованием Jinja2)

## Структура проекта
```
├── src/
│   ├── api/                    # Модули реализации API и frontend части
│   ├── core/                   # Модули для клонирования, индексации, поиска и настройки проекта
│   ├── schemas/                # Схемы проверки валидности ввода параметров для API
│   ├── static/                 # Статические файлы приложения
│   ├── templates/              # Шаблоны html-страниц
│   ├── main.py                 # Основной файл для запуска web-приложения
│   ├── run_clonning.py         # Модуль для запуска клонирования проектов
│   ├── run_indexing.py         # Модуль для запуска клонирования проектов
│   └── run_searching.py        # Модуль для запуска поиска по индексу через командную строку
├── index/                      # Файлы индексной базы данных
├── logs/                       # Логи работы приложения
├── .env                        # Конфигурация окружения
├── .gitignore                  # Файлы, игнорируемые в Git
├── README.md                   # Документация проекта
└── requirements.txt            # Зависимости проекта
```

## Зависимости
- **Основные:** `fastapi`, `pydantic`, `uvicorn`
- **Для конвертации файлов в markdown:** `markitdown`
- **Для работы с индексной базой данных:** `Whoosh`
- **Шаблонизатор:** `jinja2`
- **Прочее:** `markdown2`, `loguru`

## Настройка и запуск приложения
1. Склонируйте репозиторий:
    ```bash
    git clone https://github.com/VasiliyS178/knowledge_base.git .
    ```
2. Создайте новое витруальное окружение:
    ```bash
    python -m venv my_new_venv
    ```
3. Перейдите в папку с виртуальным окрежением и активируйте его:
    На unix-подобных системах (ubuntu, centos и др.)
    ```bash
    cd /path/to/my_new_venv/bin/
    source activate
    ```
    На Windows
    ```bash
    cd C:\path\to\my_new_venv\scripts
    activate
    ```
4. Перейдите в папку с проектом и установите зависимости в созданное виртуальное окружение:
    ```bash
    cd  /path/to/knowledge_base
    pip install -r requirements.txt
    ```
5. Создайте в корне проекта и настройте файл `.env`:
    ```env
    GITLAB_HOST=<https://your.corp.gitlab.site>
    GITLAB_TOKEN=<Создать в своем профиле GitLab в разделе Access Tokens>
    GROUP_ID=<ID группы для Взять из GitLab>
    REPOSITORIES_ROOT_DIR=<путь для клонирования проектов из GitLab>
    LAST_INDEXED_DTTM="1970-01-01 00:00:00" (начальное значение, потом нужно поменять на дату создания индекса)
    LOGS_PATH=<путь для сохранения логов>
    KNOWLEDGE_BASE_PATH=<путь, где лежат все файлы для наполнения базы знаний>
    INDEX_PATH=<путь, где будет размещаться индексная база (размер зависит от количества файлов)>
    ```
6. Проверьте параметры в конфиге `config.py`:
    ```config.py
    CNT_JOBS = 8  # количество потоков для индексации. Максимум зависит от процессора в вашем комьютере
    BATCH_SIZE = 1000  # количество файлов в обном батче
    START_BATCH = 1  # для пропуска обработанных батчей, если в процессе произошел сбой. Поменять перед продолжением
    MAX_FILE_SIZE_M = 2  # максимальный размер файлов для индексации в Мб
    CONVERTABLE_FORMATS = ["docx", "pptx", "html"]  # перечень может быть дополнен форматом xlsx 
    ```
7. Запуск приложения:
- Клонирование или обновление всех проектов группы GROUP_ID из GitLab (при необходимости):
   ```bash
   /path/to/my_new_venv/bin/python src/run_cloning.py
   ```
- Индексирование файлов для поиска в директории KNOWLEDGE_BASE_PATH:
   ```bash
   /path/to/my_new_venv/bin/python src/run_indexing.py
   ```
- Поиск по всем файлам в базе знаний через командную строку:
    ```bash
    /path/to/my_new_venv/bin/python src/run_searching.py your_query_string
    ```
- Поиск по всем файлам в базе знаний через web-интерфейс:
    ```bash
    /path/to/my_new_venv/bin/uvicorn src.main:app --reload
    ```
Приложение будет доступно по адресу [http://127.0.0.1:8000](http://127.0.0.1:8000)
